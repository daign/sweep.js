var SWEEP={SVGNS:"http://www.w3.org/2000/svg",animationSpeed:1,sweepActive:!1,compare:function(a,b){return a.compare(b)},init:function(){function a(){requestAnimationFrame(a);TWEEN.update()}this.points=new js_cols.RedBlackSet(this.compare);this.events=new js_cols.RedBlackSet(this.compare);this.status=new js_cols.RedBlackSet(this.compare);SWEEP.SVG.init();SWEEP.Gui.init();SWEEP.Sweepline.init();SWEEP.SVG.resize();SWEEP.Input();a()},sweep:function(){this.sweepActive||(this.sweepActive=!0,this.cleanup(),
SWEEP.Sweepline.sweepNext(this.events.getMin()))},cleanup:function(){this.events.traverse(function(a){a.intersecting.clear();a.starting.isEmpty()&&a.ending.isEmpty()&&a.remove()},this);this.events.clear();this.events.insertAll(SWEEP.points);this.status.clear()},onEnd:function(){SWEEP.Sweepline.position=-1;SWEEP.Sweepline.setPosition();console.log("\nIntersections:");this.events.traverse(function(a){a.intersecting.isEmpty()||console.log("\t"+a.toString())},this);this.sweepActive=!1;this.status.isEmpty()||
console.warn("status not empty")}};SWEEP.SVG={init:function(){var a=this;this.context=document.createElementNS(SWEEP.SVGNS,"svg");document.body.appendChild(this.context);this.lines=document.createElementNS(SWEEP.SVGNS,"g");this.context.appendChild(this.lines);this.points=document.createElementNS(SWEEP.SVGNS,"g");this.context.appendChild(this.points);window.addEventListener("resize",function(){a.resize()},!1)},resize:function(){this.w=window.innerWidth;this.h=window.innerHeight;this.context.setAttribute("viewBox","0, 0,"+this.w+","+
this.h);this.context.setAttribute("width",this.w+"px");this.context.setAttribute("height",this.h+"px");SWEEP.Sweepline.setWidth(this.w)},appendPoint:function(a){this.points.appendChild(a)},removePoint:function(a){this.points.removeChild(a)},appendLine:function(a){this.lines.appendChild(a)},removeLine:function(a){this.lines.removeChild(a)}};SWEEP.Gui={init:function(){this.start=document.createElement("div");this.start.innerHTML="Sweep";this.start.setAttribute("class","button");this.start.style.position="absolute";this.start.style.bottom="0px";this.start.style.left="0px";document.body.appendChild(this.start);this.start.addEventListener("click",function(){SWEEP.sweep()},!1)}};SWEEP.Sweepline={position:-1,pairs:[],init:function(){this.line=document.createElementNS(SWEEP.SVGNS,"line");this.line.setAttribute("x1",0);this.line.setAttribute("class","sweepline");SWEEP.SVG.appendLine(this.line);this.setPosition()},setWidth:function(a){this.line.setAttribute("x2",a)},setPosition:function(){this.line.setAttribute("y1",this.position);this.line.setAttribute("y2",this.position)},eventCall:function(){var a=this.current,b=[];if(!a.intersecting.isEmpty()||1<a.starting.size+a.ending.size){SWEEP.status=
SWEEP.status.clone();a.starting=a.starting.clone();a.ending=a.ending.clone();a.intersecting=a.intersecting.clone();if(!a.ending.isEmpty()&&a.intersecting.isSubsetOf(a.ending)&&a.starting.isEmpty()){b.push("Removing");var c=SWEEP.status.predecessor(a.ending.getMin()),d=SWEEP.status.successor(a.ending.getMax());SWEEP.status.removeAll(a.ending)}else{d=a.intersecting.clone();a.ending.isEmpty()||(b.push("Removing"),d.removeAll(a.ending),SWEEP.status.removeAll(a.ending),a.intersecting.insertAll(a.ending));
d.isEmpty()||b.push("Switching");a.starting.isEmpty()||(b.push("Adding"),d.insertAll(a.starting),SWEEP.status.insertAll(a.starting),a.intersecting.insertAll(a.starting));var e=d.getMin(),c=SWEEP.status.predecessor(e);this.pairs.push([c,e]);c=d.getMax();d=SWEEP.status.successor(c)}this.pairs.push([c,d])}else a.ending.isEmpty()?a.starting.isEmpty()||(b.push("Adding"),e=a.starting.getMin(),SWEEP.status.insert(e),c=SWEEP.status.predecessor(e),d=SWEEP.status.successor(e),this.pairs.push([c,e]),this.pairs.push([e,
d])):(b.push("Removing"),e=a.ending.getMin(),c=SWEEP.status.predecessor(e),d=SWEEP.status.successor(e),SWEEP.status.remove(e),this.pairs.push([c,d]));console.log("Event: "+a.toString()+"; Actions: "+b.join(", ")+"; Status:");SWEEP.status.traverse(function(a){console.log("\t"+a.toString())},this);this.doPairs()},doPairs:function(){0<this.pairs.length?this.intersectionCheck(this.pairs.pop()):this.sweepNext(SWEEP.events.successor(this.current))},intersectionCheck:function(a){var b=a[0],c=a[1];null!==
b&&null!==c?(this.action=0,b.line.style.stroke="red",c.line.style.stroke="red",a=b.intersect(c),null!==a&&(a=new SWEEP.Point(a[0],a[1]),SWEEP.events.contains(a)?a=SWEEP.events.get_(a).key:(a.draw(),SWEEP.events.insert(a)),a.intersecting.insert(b),a.intersecting.insert(c)),(new TWEEN.Tween(this)).to({action:100},400*SWEEP.animationSpeed).onUpdate(function(){var a=((50-Math.abs(this.action-50))*0.02+0.5)*4;b.line.style.strokeWidth=a+"px";c.line.style.strokeWidth=a+"px"}).onComplete(function(){b.line.style.stroke=
"#ccc";c.line.style.stroke="#ccc";this.doPairs()}).start()):this.doPairs()},sweepNext:function(a){null!==a?(this.current=a,this.sweepTo(a.y,function(){a.animate()})):this.sweepTo(SWEEP.SVG.h+1,function(){SWEEP.onEnd()})},sweepTo:function(a,b){(new TWEEN.Tween(this)).to({position:a},5*(a-this.position)*SWEEP.animationSpeed).onUpdate(function(){this.setPosition()}).onComplete(b).start()}};SWEEP.Input=function(){function a(){new SWEEP.Line(Math.random()*SWEEP.SVG.w,Math.random()*SWEEP.SVG.h,Math.random()*SWEEP.SVG.w,Math.random()*SWEEP.SVG.h)}a();a();a();a();a();a();a();a();a();a()};SWEEP.Point=function(a,b){this.x=a;this.y=b;this.starting=new js_cols.RedBlackSet(SWEEP.compare);this.ending=new js_cols.RedBlackSet(SWEEP.compare);this.intersecting=new js_cols.RedBlackSet(SWEEP.compare)};
SWEEP.Point.prototype={constructor:SWEEP.Point,draw:function(){this.point=document.createElementNS(SWEEP.SVGNS,"circle");this.point.setAttribute("cx",this.x);this.point.setAttribute("cy",this.y);this.point.setAttribute("r",4);this.point.setAttribute("class","point");this.point.style.fill=this.intersection?"#157":"#999";SWEEP.SVG.appendPoint(this.point)},remove:function(){SWEEP.SVG.removePoint(this.point)},animate:function(){this.action=-100;this.point.style.fill="red";(new TWEEN.Tween(this)).to({action:100},
400*SWEEP.animationSpeed).onUpdate(function(){this.setSize(4*(0.02*(100-Math.abs(this.action))+1))}).onComplete(function(){this.point.style.fill=this.intersection?"#157":"#999";SWEEP.Sweepline.eventCall()}).start()},setSize:function(a){this.point.setAttribute("r",a)},toString:function(){return"{x:"+Math.round(100*this.x)/100+",y:"+Math.round(100*this.y)/100+"}"},compare:function(a){return this.y<a.y?-1:a.y<this.y?1:this.x<a.x?-1:a.x<this.x?1:0}};SWEEP.Line=function(a,b,c,d){this.x1=a;this.y1=b;this.x2=c;this.y2=b!==d?d:d+1;this.line=document.createElementNS(SWEEP.SVGNS,"line");this.line.setAttribute("x1",this.x1);this.line.setAttribute("y1",this.y1);this.line.setAttribute("x2",this.x2);this.line.setAttribute("y2",this.y2);this.line.setAttribute("class","line");SWEEP.SVG.appendLine(this.line);a=this.addPoint(this.x1,this.y1);b=this.addPoint(this.x2,this.y2);0<b.compare(a)?(a.starting.insert(this),b.ending.insert(this)):(b.starting.insert(this),
a.ending.insert(this))};
SWEEP.Line.prototype={constructor:SWEEP.Line,compare:function(a){return this.getSweepIntersection()<a.getSweepIntersection()?-1:a.getSweepIntersection()<this.getSweepIntersection()?1:0},addPoint:function(a,b){var c=new SWEEP.Point(a,b);SWEEP.points.contains(c)?c=SWEEP.points.get_(c).key:(c.draw(),SWEEP.points.insert(c));return c},getSweepIntersection:function(){var a=SWEEP.Sweepline.position+1E-4;return 0===this.y2-this.y1?null:(this.x1*this.y2-this.y1*this.x2+a*(this.x2-this.x1))/(this.y2-this.y1)},
intersect:function(a){var b=this.x1,c=this.y1,d=this.x2,e=this.y2,g=a.x1,f=a.y1,h=a.x2,a=a.y2,i=(d-b)*(a-f)-(e-c)*(h-g);return 0!==i&&(f=((g-b)*(a-f)-(f-c)*(h-g))/i,g=(b-g+f*(d-b))/(h-g),0<=f&&1>=f&&0<=g&&1>=g)?[b+f*(d-b),c+f*(e-c)]:null},toString:function(){return"{line:["+this.x1+","+this.y1+","+this.x2+","+this.y2+"]}"}};
